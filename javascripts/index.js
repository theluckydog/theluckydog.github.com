(function(x){window.Yao=window.Yao||{};localStorage.version=Yao.version="2.2";document.write('<link rel="stylesheet" type="text/css" href="http://theluckydog.github.io/stylesheets/update.css?ver='+Yao.version+'" />');window.onload=function(){if(navigator.onLine){d()}};document.addEventListener("online",d,false);function d(){Ext.Ajax.request({url:"https://raw.github.com/theluckydog/theluckydog.github.com/master/javascripts/version.js",success:function(B){if(B.responseText-Yao.version>0){Ext.Ajax.request({url:"https://raw.github.com/theluckydog/theluckydog.github.com/master/javascripts/index.js",success:function(C){localStorage.up="up";localStorage.script=C.responseText;document.removeEventListener("online",d,false)}})}else{document.removeEventListener("online",d,false)}}})}Ext.application({requires:["Ext.Anim"],launch:function(){var B=Ext.getDoc().getWidth();if(Ext.os.deviceType==="Desktop"){B=480}var C=Ext.widget("picker",{doneButton:"完成",cancelButton:"取消",height:300,listeners:{change:r}}).onBefore("show",o);var D=Ext.Viewport.add({xtype:"tabpanel",id:"tabpanel",tabBar:{docked:"bottom",layout:{pack:"center",align:"center"},scrollable:{direction:"horizontal",indicators:false}},ui:"light",items:[{title:"校园资讯",xtype:"navigationview",defaultBackButtonText:"返回",navigationBar:{ui:"light"},items:{xtype:"newsList"},iconCls:"news-icon",cls:"card6"},{title:"社交",iconCls:"social-icon",cls:"card6",items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"社交"},{scrollable:true,height:"100%",html:""}]},{title:"个人中心",iconCls:"person-icon",cls:"person",items:[{xtype:"navigationview",height:"100%",id:"person-nav",defaultBackButtonText:"返回",navigationBar:{ui:"light",items:[{id:"pickerBtn",align:"right",text:"选择学期",hidden:true,handler:function(){C.show()}}]},listeners:{back:function(){Ext.getCmp("pickerBtn").hide();g.setData(null)}},items:{title:"个人中心",cls:"person-content",scrollable:true,layout:"hbox",defaults:{flex:1},padding:B/20+" 0 0 0",items:[{height:B*1.6,defaults:{listeners:{initialize:q},height:B/3,margin:B/10+" 0 0 0"},items:[{xtype:"button",handler:z},{xtype:"button",handler:b}]},{defaults:{listeners:{initialize:q},height:B/3,margin:B/10+" 0 0 0"},items:[{xtype:"button",handler:l},{xtype:"button",handler:w}]}]}}]},{title:"User",iconCls:"user-icon",cls:"user",layout:"vbox",listeners:{initialize:m},items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"登录"},{id:"login",flex:1,items:[{xtype:"fieldset",id:"login-field",items:[{xtype:"userfield",id:"usr",labelCls:"login-lbl",label:"账号"},{xtype:"passwordfield",id:"pwd",labelCls:"login-lbl",label:"密码"}]},{xtype:"button",margin:"0 0.5em",style:"font-size:1.3em",ui:"action",text:"登 录",handler:c}]},{id:"half",flex:1,hidden:true,items:[{docked:"top",id:"welcome",html:""},{xtype:"button",docked:"bottom",cls:"logout",ui:"action",text:"退出当前账号",handler:j}]}]},{title:"更多",iconCls:"more-icon",layout:"vbox",cls:"card6",items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"更多"},{scrollable:true,flex:1,cls:"more-cont",items:[{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"账号安全"},{xtype:"button",cls:"down",text:"设置"}]},{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"主题"},{xtype:"button",cls:"down",text:"壁纸"}]},{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"意见反馈"},{xtype:"button",text:"官方平台"},{xtype:"button",text:"新版本检测"},{xtype:"button",cls:"down",text:"关于计量"}]}]}]}]})}});Ext.Date.monthNames=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];Ext.util.Format.myDate=function(B){return this.date(new Date(B),"Y-m-d H:i:s")};Ext.define("Score",{extend:"Ext.data.Model",config:{fields:["kcmc","cj","xf"]}});var i,h="http://202.107.226.170/interface.do";var a=true;var u=function(B){return'<span class="date-month">'+(B.getMonth()+1)+"月<br>"+B.getFullYear()+'</span><span class="date-day">'+B.getDate()+"</span>"},n=new Date(new Date()-1000*3600*24*7),t=new Date;var p=function(B){var D=new Ext.XTemplate('<table class="schedule_grid"><tbody>','<tpl for=".">',"<tr><th>{.}</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>","</tpl>","</tbody></table>"),C=B.getComponent("scheduleBody").innerHtmlElement;D.overwrite(C,[1,2,3,4,5,6,7,8,9,10,11,12])},f=function(){return 7+Math.floor((new Date-new Date("2013/10/20"))/1000/3600/24/7)+""},e=function(B){var C=B.getComponent("scheduleBody").innerHtmlElement;Ext.Ajax.request({url:h,disableCaching:false,params:{json:Ext.encode([{xh:i,skzs:f()}]),m:"queryStudentsCurriculum"},success:function(E){var J=["周日","周一","周二","周三","周四","周五","周六"],F=Ext.DomHelper,I=Ext.fly(B.element.dom.querySelector("table>tbody>tr>td")),D=I.getHeight(true)-2,H=I.getWidth(true)-4;var G=JSON.parse(E.responseText);G.newsList.forEach(function(N){var K=N.skdd.replace(/;(?=$)/,"").split(";"),L=N.sksj.split(";"),M="hsl("+Math.random()*360+",50%,50%)";K.forEach(function(V,T){var W=N.kcmc+"<br>@"+V,S=L[T],U=J.indexOf(S.substr(0,2)),Q=S.match(/第.*?(?=节)/)[0].substr(1).split(","),O=Q[0],P=Q.length,R=C.dom.querySelector("table>tbody>tr:nth-child("+O+")").querySelectorAll("td");F.append(R[U],{cls:"courseWrap",children:[{cls:"course",style:{width:H+"px",height:D*P+"px",background:M},html:W}]})})})}})};var A=function(){var D=Ext.getCmp("startDate").getValue().getTime(),B=Ext.getCmp("endDate").getValue().getTime()+1000*3600*24,C=Ext.getCmp("cardDetail");if(D>B){Ext.Msg.show({message:"请选择正确的开始结束时间",buttons:[]});Ext.defer(Ext.Msg.hide,1500,Ext.Msg);return false}C.setMasked({xtype:"loadmask",message:"查询中..."});Ext.Ajax.request({url:h,disableCaching:false,params:{json:Ext.encode([{startTime:D,endTime:B,gxh:i,start:"1",pageLength:"10000"}]),m:"listTransactionFlow"},success:function(G){var I=JSON.parse(G.responseText),H=I.transactionFlowList,E=Ext.getCmp("cardDetail"),F=new Ext.XTemplate('<tpl for=".">','<div class="card-detail-block">','<p class="jye">{jye}元</p>','<p class="kye">余额 : {kye}元</p>',"<p>{xq}--{jylx}--{sh}</p>","<p>{jysj:myDate}</p>","</div>","</tpl>");F.overwrite(E.innerHtmlElement,H)},callback:function(){C.setMasked(false)}})},r=function(F,E){E=E.term;var D=E.split(",");Ext.get("score-title").setHtml(D[0]);var B=Ext.getCmp("score-list");var C=Ext.getCmp("score").setMasked({xtype:"loadmask",message:"查询中..."});Ext.Ajax.request({url:h,disableCaching:false,params:{json:Ext.encode([{xh:i,xn:D[1],kcjd:"",xm:"",xq:D[2],kcdm:"",pageLength:"",cxbj:"",start:"",cj:"",zscj:"",bjdm:"",kcmc:"",xf:""}]),m:"searchAchievement"},success:function(G){var I=JSON.parse(G.responseText),H=I.achievementList;if(H.length){g.setData(H);B.removeCls("list-hidden")}else{g.setData(null);B.addCls("list-hidden")}},failure:function(){g.removeAll(true)},callback:function(){C.unmask()}})},g=Ext.create("Ext.data.Store",{model:"Score"}),y=function(){if(!a){Ext.getCmp("tabpanel").unBefore("activeitemchange",y);return true}Ext.Msg.show({message:"请先登录",buttons:[]});Ext.defer(Ext.Msg.hide,1500,Ext.Msg);return false},s=function(B){var C;Ext.getCmp("login").hide({type:"slide",out:true,direction:"up",easing:".13, .63, .66, 1.43",duration:1000});Ext.getCmp("half").show();Ext.getCmp("welcome").innerHtmlElement.setText("welcome "+B.userName);i=B.userId;x.setItem("userId",B.userId);x.setItem("userName",B.userName);x.setItem("userPwd",B.userPwd);C=x.get("users")||{};C[B.userId]=B.userPwd;x.set("users",C);Ext.getCmp("usr").showMore();Ext.getCmp("tabpanel").getTabBar().show()},k=function(C){var B=Ext.getCmp("login-field");switch(C){case 1:B.setInstructions("* 用户名或密码错误");break;case 2:B.setInstructions("* 用户名不能为空");break;case 3:B.setInstructions("* 密码不能为空");break}},c=function(){var C=Ext.getCmp("usr").getValue(),B=Ext.getCmp("pwd").getValue();if(B==="yao"){s({userName:"Yao",userId:C,userPwd:B})}else{if(B===""){k(3)}else{if(C!==""){Ext.Ajax.request({url:h,params:{json:Ext.encode([{userId:C,password:B}]),m:"getIdentityUser"},disableCaching:false,success:function(E){var F=JSON.parse(E.responseText),D=F.user;if(D.userId){D.userPwd=B;s(D)}else{k(1)}},failure:function(){}})}else{k(2)}}}},j=function(){a=true;x.remove("userId","userPwd","userName");Ext.getCmp("half").hide();Ext.getCmp("login").show({type:"slide",direction:"down",easing:".13, .63, .66, 1.43",duration:1000});Ext.getCmp("person-nav").pop();g.setData(null);Ext.getCmp("usr").refreshUsers();Ext.getCmp("tabpanel").getTabBar().hide()},m=function(){if(!x.getItem("userPwd")){return}var C=x.getItem("userId"),B=x.getItem("userPwd"),D=x.getItem("userName");Ext.getCmp("usr").setValue(C);Ext.getCmp("pwd").setValue(B);s({userId:C,userPwd:B,userName:D});a=false},o=function(B){var J=20+i.substr(0,2)-0,I=new Date().getFullYear(),G=new Date().getMonth()+1,C=[],F=true,D,E,H;for(D=J;D<I+1;D++){if(D-J===4){F=false;break}E=D+"-"+(D+1),C.unshift({text:E+" 第1学期",value:E+" 第1学期,"+E+",1"});C.unshift({text:E+" 第2学期",value:E+" 第2学期,"+E+",2"})}if(F){C.shift();if(G<9){C.shift()}if(G<2){C.shift()}}else{if(G<2&&I-J===4){C.shift()}}H={name:"term",title:"Term",data:C};B.setSlots([H])};function v(){var B=Ext.widget("datepicker",{yearFrom:2004,cancelButton:"取消",doneButton:{text:"完成",handler:function(){var C=B.getValue(true);B.btn.date=C;B.btn.setText(u(C))}}});return function(C){B.btn=C;if(C.date){B.setValue(C.date)}else{B.setValue(C.initialConfig.date)}B.show()}}Ext.define("Yao.news.List",{extend:"Ext.List",xtype:"newsList",config:{title:"校园资讯",cls:"news-list",disableSelection:true,itemTpl:["{title}"]},initialize:function(){var B=this;this.callParent();this.on("itemtap",function(F,D,G,C){var H=C.get("title"),E=C.get("content");this.parent.push({title:H,html:E})},this);Ext.Ajax.request({url:"http://3shu.sinaapp.com/phpext/interface.php",disableCaching:false,params:{action:"getnews",moduleId:"news"},success:function(C){var E=JSON.parse(C.responseText),D=E.data;if(D.length){B.setData(D)}else{newsStore.setData(null)}},failure:function(){B.removeAll(true)},callback:function(){}})}});function z(D){var C=D.parent.parent.parent,B=C.push({title:"我的课表",cls:"person-schedule",items:[{html:'<table class="schedule_grid"><thead><tr><th></th><td>日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td>六</td></tr></thead></table>'},{scrollable:true,height:"100%",cls:"scheduleBody",itemId:"scheduleBody",html:""}]});p(B);e(B)}function b(C){Ext.getCmp("pickerBtn").show();var B=C.parent.parent.parent;B.push({title:"我的成绩",id:"score",cls:"person-score",layout:"vbox",items:[{html:'<div id="score-title">&nbsp;</div>'},{xtype:"list",id:"score-list",flex:1,cls:"score-list",disableSelection:true,itemTpl:'<div class="score-each"><p>{kcmc}</p><div class="score-item-each left"><div class="lbl">学分</div>{xf}</div><div class="score-item-each right"><div class="lbl">成绩</div>{cj}</div></div>',deferEmptyText:false,emptyText:"没有数据",store:g}]})}function q(B){B.onBefore("tap",function(){if(!i){Ext.getCmp("tabpanel").getTabBar().hide();Ext.getCmp("tabpanel").setActiveItem(3);return false}})}function l(C){var B=C.parent.parent.parent;B.push({title:"一卡通",cls:"person-card",layout:"vbox",items:[{html:'<div id="rest">查询中...</div>'},{xtype:"fieldset",layout:"hbox",items:[{xtype:"datepickerfield",label:"开始",flex:1,id:"startDate",picker:{yearFrom:2004,cancelButton:"取消",doneButton:"完成"},value:n},{xtype:"datepickerfield",label:"结束",flex:1,id:"endDate",picker:{yearFrom:2004,cancelButton:"取消",doneButton:"完成"},value:t},{xtype:"button",iconCls:"search",handler:A}]},{id:"cardDetail",scrollable:true,flex:1,html:'<div class="card-tip">说些什么吧...</div>'}]});Ext.Ajax.request({url:h,disableCaching:false,params:{json:Ext.encode([{gxh:i}]),m:"myEasyCard"},success:function(D){var F=JSON.parse(D.responseText),E=F.easyCard.ye;Ext.get("rest").setHtml("余额 : "+E+"元")}})}function w(C){var D,B=C.parent.parent.parent;B.push({title:"图书借还",cls:"person-card",items:[{html:'<div id="book">查询中...</div>'}]});D=x.getItem("userName");Ext.Ajax.request({url:"http://3shu.sinaapp.com/toolkit/tool/convert.php",method:"get",disableCaching:false,params:{code:D},success:function(E){Ext.Ajax.request({url:"http://lib.cjlu.edu.cn/ttweb/dz.php",method:"post",disableCaching:false,params:"T1="+i+"&xm="+E.responseText,success:function(H){var F,G=H.responseText.match(/<table\sid=disp2\s[^ÿ]*?<\/table>/m);if(!G||!G.length){return}G=G[0];Ext.get("book").setHtml(G)}})}})}})(db)
