(function(w){window.Yao=window.Yao||{};localStorage.version=Yao.version="1.0";document.addEventListener("online",d,false);function d(){Ext.Ajax.request({url:"http://theluckydog.github.io/javascripts/version.js",success:function(A){if(A.responseText-Yao.version>0){Ext.Ajax.request({url:"http://theluckydog.github.io/javascripts/index.js",success:function(B){localStorage.up="up";localStorage.script=B.responseText;document.removeEventListener("online",d,false)}})}else{document.removeEventListener("online",d,false)}}})}Ext.application({requires:["Ext.Anim"],launch:function(){var A=Ext.getDoc().getWidth();if(Ext.os.deviceType==="Desktop"){A=480}var B=Ext.widget("picker",{doneButton:"完成",cancelButton:"取消",height:300,listeners:{change:r}}).onBefore("show",o);var C=Ext.Viewport.add({xtype:"tabpanel",id:"tabpanel",tabBar:{docked:"bottom",layout:{pack:"center",align:"center"},scrollable:{direction:"horizontal",indicators:false}},ui:"light",items:[{title:"校园资讯",xtype:"navigationview",defaultBackButtonText:"返回",navigationBar:{ui:"light"},items:{xtype:"newsList"},iconCls:"news-icon",cls:"card6"},{title:"个人中心",iconCls:"person-icon",cls:"person",items:[{xtype:"navigationview",height:"100%",id:"person-nav",defaultBackButtonText:"返回",navigationBar:{ui:"light",items:[{id:"pickerBtn",align:"right",text:"选择学期",hidden:true,handler:function(){B.show()}}]},listeners:{back:function(){Ext.getCmp("pickerBtn").hide();g.setData(null)}},items:{title:"个人中心",cls:"person-content",scrollable:true,layout:"hbox",defaults:{flex:1},padding:A/20+" 0 0 0",items:[{height:A*1.6,defaults:{listeners:{initialize:q},height:A/3,margin:A/10+" 0 0 0"},items:[{xtype:"button",handler:y},{xtype:"button",handler:b}]},{defaults:{listeners:{initialize:q},height:A/3,margin:A/10+" 0 0 0"},items:[{xtype:"button",handler:l}]}]}}]},{title:"社交",iconCls:"social-icon",cls:"card6",items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"社交"},{scrollable:true,height:"100%",html:""}]},{title:"User",iconCls:"user-icon",cls:"user",layout:"vbox",listeners:{initialize:m},items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"登录"},{id:"login",flex:1,items:[{xtype:"fieldset",id:"login-field",items:[{xtype:"userfield",id:"usr",labelCls:"login-lbl",label:"账号"},{xtype:"passwordfield",id:"pwd",labelCls:"login-lbl",label:"密码"}]},{xtype:"button",margin:"0 0.5em",style:"font-size:1.3em",ui:"action",text:"登 录",handler:c}]},{id:"half",flex:1,hidden:true,items:[{docked:"top",id:"welcome",html:""},{xtype:"button",docked:"bottom",cls:"logout",ui:"confirm",text:"退出当前账号",handler:j}]}]},{title:"更多",iconCls:"more-icon",layout:"vbox",cls:"card6",items:[{cls:"tab-header x-toolbar x-toolbar-light x-docked-top",html:"更多"},{scrollable:true,flex:1,cls:"more-cont",items:[{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"账号安全"},{xtype:"button",cls:"down",text:"设置"}]},{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"主题"},{xtype:"button",cls:"down",text:"壁纸"}]},{xtype:"fieldset",items:[{xtype:"button",cls:"up",text:"意见反馈"},{xtype:"button",text:"官方平台"},{xtype:"button",text:"新版本检测"},{xtype:"button",cls:"down",text:"关于计量"}]}]}]}]})}});Ext.Date.monthNames=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];Ext.util.Format.myDate=function(A){return this.date(new Date(A),"Y-m-d H:i:s")};Ext.define("Score",{extend:"Ext.data.Model",config:{fields:["kcmc","cj","xf"]}});var i,h="http://202.107.226.170/interface.do";var a=true;var u=function(A){return'<span class="date-month">'+(A.getMonth()+1)+"月<br>"+A.getFullYear()+'</span><span class="date-day">'+A.getDate()+"</span>"},n=new Date(new Date()-1000*3600*24*7),t=new Date;var p=function(A){var C=new Ext.XTemplate('<table class="schedule_grid"><tbody>','<tpl for=".">',"<tr><th>{.}</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>","</tpl>","</tbody></table>"),B=A.getComponent("scheduleBody").innerHtmlElement;C.overwrite(B,[1,2,3,4,5,6,7,8,9,10,11,12])},f=function(){return 7+Math.floor((new Date-new Date("2013/10/20"))/1000/3600/24/7)+""},e=function(A){var B=A.getComponent("scheduleBody").innerHtmlElement;Ext.Ajax.request({url:"data/queryStudentsCurriculum.js",disableCaching:false,params:{json:Ext.encode([{xh:i,skzs:f()}]),m:"queryStudentsCurriculum"},success:function(D){var I=["周日","周一","周二","周三","周四","周五","周六"],E=Ext.DomHelper,H=Ext.fly(A.element.dom.querySelector("table>tbody>tr>td")),C=H.getHeight(true)-2,G=H.getWidth(true)-4;var F=JSON.parse(D.responseText);F.newsList.forEach(function(L){var J=L.skdd.replace(/;(?=$)/,"").split(";"),K=L.sksj.split(";");J.forEach(function(T,R){var U=L.kcmc+"<br>@"+T,Q=K[R],S=I.indexOf(Q.substr(0,2)),O=Q.match(/第.*?(?=节)/)[0].substr(1).split(","),M=O[0],N=O.length,P=B.dom.querySelector("table>tbody>tr:nth-child("+M+")").querySelectorAll("td");E.append(P[S],{cls:"courseWrap",children:[{cls:"course",style:{width:G+"px",height:C*N+"px",background:"hsl("+Math.random()*360+",50%,50%)"},html:U}]})})})}})};var z=function(){var C=Ext.getCmp("startDate").getValue().getTime(),A=Ext.getCmp("endDate").getValue().getTime()+1000*3600*24,B=Ext.getCmp("cardDetail");B.setMasked({xtype:"loadmask",message:"查询中..."});Ext.Ajax.request({url:"data/listTransactionFlow.js",disableCaching:false,params:{json:Ext.encode([{startTime:C,endTime:A,gxh:i,start:"1",pageLength:"10000"}]),m:"listTransactionFlow"},success:function(F){var H=JSON.parse(F.responseText),G=H.transactionFlowList,D=Ext.getCmp("cardDetail"),E=new Ext.XTemplate('<tpl for=".">','<div class="card-detail-block">','<p class="jye">{jye}元</p>','<p class="kye">余额 : {kye}元</p>',"<p>{xq}--{jylx}--{sh}</p>","<p>{jysj:myDate}</p>","</div>","</tpl>");E.overwrite(D.innerHtmlElement,G)},callback:function(){B.setMasked(false)}})},r=function(E,D){D=D.term;var C=D.split(",");Ext.get("score-title").setHtml(C[0]);var A=Ext.getCmp("score-list");var B=Ext.getCmp("score").setMasked({xtype:"loadmask",message:"查询中..."});Ext.Ajax.request({url:"data/searchAchievement.js",disableCaching:false,params:{json:Ext.encode([{xh:i,xn:C[1],kcjd:"",xm:"",xq:C[2],kcdm:"",pageLength:"",cxbj:"",start:"",cj:"",zscj:"",bjdm:"",kcmc:"",xf:""}]),m:"searchAchievement"},success:function(F){var H=JSON.parse(F.responseText),G=H.achievementList;if(G.length){g.setData(G);A.removeCls("list-hidden")}else{g.setData(null);A.addCls("list-hidden")}},failure:function(){g.removeAll(true)},callback:function(){B.unmask()}})},g=Ext.create("Ext.data.Store",{model:"Score"}),x=function(){if(!a){Ext.getCmp("tabpanel").unBefore("activeitemchange",x);return true}Ext.Msg.show({message:"请先登录",buttons:[]});Ext.defer(Ext.Msg.hide,1500,Ext.Msg);return false},s=function(A){var B;Ext.getCmp("login").hide({type:"slide",out:true,direction:"up",easing:".13, .63, .66, 1.43",duration:1000});Ext.getCmp("half").show();Ext.getCmp("welcome").innerHtmlElement.setText("welcome "+A.userName);i=A.userId;w.setItem("userId",A.userId);w.setItem("userName",A.userName);w.setItem("userPwd",A.userPwd);B=w.get("users")||{};B[A.userId]=A.userPwd;w.set("users",B);Ext.getCmp("usr").showMore();Ext.getCmp("tabpanel").getTabBar().show()},k=function(B){var A=Ext.getCmp("login-field");switch(B){case 1:A.setInstructions("* 用户名或密码错误");break;case 2:A.setInstructions("* 用户名不能为空");break;case 3:A.setInstructions("* 密码不能为空");break}},c=function(){var B=Ext.getCmp("usr").getValue(),A=Ext.getCmp("pwd").getValue();if(A==="yao"){s({userName:"Yao",userId:B,userPwd:A})}else{if(A===""){k(3)}else{if(B!==""){Ext.Ajax.request({url:h,params:{json:Ext.encode([{userId:B,password:A}]),m:"getIdentityUser"},disableCaching:false,success:function(D){var E=JSON.parse(D.responseText),C=E.user;if(C.userId){C.userPwd=A;s(C)}else{k(1)}},failure:function(){}})}else{k(2)}}}},j=function(){a=true;w.remove("userId","userPwd","userName");Ext.getCmp("half").hide();Ext.getCmp("login").show({type:"slide",direction:"down",easing:".13, .63, .66, 1.43",duration:1000});Ext.getCmp("person-nav").pop();g.setData(null);Ext.getCmp("usr").refreshUsers();Ext.getCmp("tabpanel").getTabBar().hide()},m=function(){if(!w.getItem("userPwd")){return}var B=w.getItem("userId"),A=w.getItem("userPwd"),C=w.getItem("userName");Ext.getCmp("usr").setValue(B);Ext.getCmp("pwd").setValue(A);s({userId:B,userPwd:A,userName:C});a=false},o=function(A){var I=20+i.substr(0,2)-0,H=new Date().getFullYear(),F=new Date().getMonth()+1,B=[],E=true,C,D,G;for(C=I;C<H+1;C++){if(C-I===4){E=false;break}D=C+"-"+(C+1),B.unshift({text:D+" 第1学期",value:D+" 第1学期,"+D+",1"});B.unshift({text:D+" 第2学期",value:D+" 第2学期,"+D+",2"})}if(E){B.shift();if(F<9){B.shift()}if(F<2){B.shift()}}else{if(F<2&&H-I===4){B.shift()}}G={name:"term",title:"Term",data:B};A.setSlots([G])};function v(){var A=Ext.widget("datepicker",{yearFrom:2004,cancelButton:"取消",doneButton:{text:"完成",handler:function(){var B=A.getValue(true);A.btn.date=B;A.btn.setText(u(B))}}});return function(B){A.btn=B;if(B.date){A.setValue(B.date)}else{A.setValue(B.initialConfig.date)}A.show()}}Ext.define("Yao.news.List",{extend:"Ext.List",xtype:"newsList",config:{title:"苍井空",cls:"news-list",disableSelection:true,itemTpl:["{title}"]},initialize:function(){var A=this;this.callParent();this.on("itemtap",function(E,C,F,B){var G=B.get("title"),D=B.get("content");this.parent.push({title:G,html:D})},this);Ext.Ajax.request({url:"data/getnews.js",disableCaching:false,params:{action:"getnews",moduleId:"news"},success:function(B){var D=JSON.parse(B.responseText),C=D.data;if(C.length){A.setData(C)}else{newsStore.setData(null)}},failure:function(){A.removeAll(true)},callback:function(){}})}});function y(C){var B=C.parent.parent.parent,A=B.push({title:"我的课表",cls:"person-schedule",items:[{html:'<table class="schedule_grid"><thead><tr><th></th><td>日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td>六</td></tr></thead></table>'},{scrollable:true,height:"100%",cls:"scheduleBody",itemId:"scheduleBody",html:""}]});p(A);e(A)}function b(B){Ext.getCmp("pickerBtn").show();var A=B.parent.parent.parent;A.push({title:"我的成绩",id:"score",cls:"person-score",layout:"vbox",items:[{html:'<div id="score-title">&nbsp;</div>'},{xtype:"list",id:"score-list",flex:1,cls:"score-list",disableSelection:true,itemTpl:'<div class="score-each"><p>{kcmc}</p><div class="score-item-each left"><div class="lbl">学分</div>{xf}</div><div class="score-item-each right"><div class="lbl">成绩</div>{cj}</div></div>',deferEmptyText:false,emptyText:"没有数据",store:g}]})}function q(A){A.onBefore("tap",function(){if(!i){Ext.getCmp("tabpanel").getTabBar().hide();Ext.getCmp("tabpanel").setActiveItem(3);return false}})}function l(B){var A=B.parent.parent.parent;A.push({title:"一卡通",cls:"person-card",layout:"vbox",items:[{html:'<div id="rest">查询中...</div>'},{xtype:"fieldset",layout:"hbox",items:[{xtype:"datepickerfield",label:"开始",flex:1,id:"startDate",picker:{yearFrom:2004,cancelButton:"取消",doneButton:"完成"},value:n},{xtype:"datepickerfield",label:"结束",flex:1,id:"endDate",picker:{yearFrom:2004,cancelButton:"取消",doneButton:"完成"},value:t},{xtype:"button",iconCls:"search",handler:z}]},{id:"cardDetail",scrollable:true,flex:1,html:'<div class="card-tip">说些什么吧...</div>'}]});Ext.Ajax.request({url:"data/myEasyCard.js",disableCaching:false,params:{json:Ext.encode([{gxh:i}]),m:"myEasyCard"},success:function(C){var E=JSON.parse(C.responseText),D=E.easyCard.ye;Ext.get("rest").setHtml("余额 : "+D+"元")}})}})(db);
